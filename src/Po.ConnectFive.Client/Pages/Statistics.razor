@page "/statistics"
@using PoConnectFive.Shared.Services
@using PoConnectFive.Shared.Models
@inject GameStatisticsService StatisticsService

<PageTitle>PoConnectFive - Statistics</PageTitle>

<div class="statistics-container">
    <h1>Game Statistics</h1>

    @if (_statistics == null)
    {
        <div class="loading">Loading statistics...</div>
    }
    else
    {
        <div class="statistics-grid">
            <div class="stat-card">
                <h3>Overall Statistics</h3>
                <div class="stat-item">
                    <span class="label">Total Games:</span>
                    <span class="value">@_statistics.TotalGames</span>
                </div>
                <div class="stat-item">
                    <span class="label">Average Game Duration:</span>
                    <span class="value">@FormatDuration(_statistics.AverageGameDuration)</span>
                </div>
            </div>

            <div class="stat-card">
                <h3>Win Distribution</h3>
                <div class="win-distribution">
                    @foreach (var (player, wins) in _statistics.WinDistribution)
                    {
                        <div class="distribution-item">
                            <span class="player">@player</span>
                            <div class="progress-bar">
                                <div class="progress" style="width: @(wins * 100 / _statistics.TotalGames)%"></div>
                            </div>
                            <span class="wins">@wins wins</span>
                        </div>
                    }
                </div>
            </div>

            <div class="stat-card">
                <h3>Player Statistics</h3>
                <div class="player-stats">
                    @foreach (var (player, stats) in _statistics.PlayerStats)
                    {
                        <div class="player-stat-item">
                            <span class="player-name">@player</span>
                            <div class="stats-details">
                                <div class="stat">
                                    <span class="label">Wins:</span>
                                    <span class="value">@stats.Wins</span>
                                </div>
                                <div class="stat">
                                    <span class="label">Win Rate:</span>
                                    <span class="value">@stats.WinRate.ToString("F1")%</span>
                                </div>
                                <div class="stat">
                                    <span class="label">Total Games:</span>
                                    <span class="value">@stats.GamesPlayed</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <div class="stat-card">
                <h3>Winning Positions Heatmap</h3>
                <div class="heatmap-container">
                    <div class="heatmap">
                        @for (int row = 0; row < GameBoard.Rows; row++)
                        {
                            <div class="heatmap-row">
                                @for (int col = 0; col < GameBoard.Columns; col++)
                                {
                                    var position = (row, col);
                                    var count = _statistics.MostCommonWinningPositions.Count(p => p == position);
                                    var intensity = count > 0 ? Math.Min(100, count * 20) : 0;
                                    <div class="heatmap-cell" style="background-color: rgba(255, 0, 0, @(intensity / 100.0))"
                                         title="Wins from this position: @count">
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private GameStatistics? _statistics;

    protected override async Task OnInitializedAsync()
    {
        _statistics = await StatisticsService.GetStatisticsAsync();
    }

    private string FormatDuration(TimeSpan duration)
    {
        if (duration.TotalMinutes < 1)
            return $"{duration.Seconds} seconds";
        else if (duration.TotalHours < 1)
            return $"{duration.Minutes}m {duration.Seconds}s";
        else
            return $"{duration.Hours}h {duration.Minutes}m";
    }
}

<style>
    .statistics-container {
        padding: 2rem;
        max-width: 1200px;
        margin: 0 auto;
    }

    .statistics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin-top: 2rem;
    }

    .stat-card {
        background: #fff;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .stat-card h3 {
        margin-top: 0;
        color: #1976D2;
        border-bottom: 2px solid #E3F2FD;
        padding-bottom: 0.5rem;
    }

    .win-rate-bar, .pattern-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin: 0.5rem 0;
    }

    .progress-bar {
        flex: 1;
        height: 8px;
        background: #E3F2FD;
        border-radius: 4px;
        overflow: hidden;
    }

    .progress {
        height: 100%;
        background: #1976D2;
        transition: width 0.3s ease;
    }

    .recent-games {
        max-height: 300px;
        overflow-y: auto;
    }

    .recent-game {
        padding: 0.5rem;
        border-bottom: 1px solid #E3F2FD;
    }

    .recent-game:last-child {
        border-bottom: none;
    }

    .winner {
        color: #1976D2;
        font-weight: bold;
    }

    @@media (max-width: 768px) {
        .statistics-grid {
            grid-template-columns: 1fr;
        }
    }
</style> 