sequenceDiagram
    participant User
    participant GamePage as Game.razor
    participant HttpClient
    participant API as LeaderboardController
    participant TelemetryClient
    participant TableStorage as TableStorageService
    participant Azure as Azure Table Storage
    participant AppInsights as Application Insights

    Note over User,AppInsights: Game Completion Flow with Telemetry

    User->>GamePage: Makes final move
    activate GamePage
    GamePage->>GamePage: Check win condition
    GamePage->>GamePage: Calculate game duration

    alt Player Wins
        GamePage->>GamePage: Display victory animation
        GamePage->>GamePage: Play sound effect
    end

    GamePage->>HttpClient: POST /api/leaderboard/playerstats
    Note right of HttpClient: PlayerStatUpdateDto:<br/>PlayerName, Difficulty,<br/>Result, GameTimeMs

    activate HttpClient
    HttpClient->>API: POST request with stats
    activate API

    API->>API: Log request (Serilog)
    API->>API: Validate ModelState

    alt Invalid Data
        API-->>HttpClient: 400 Bad Request
        HttpClient-->>GamePage: Error response
        GamePage->>GamePage: Show error message
    else Valid Data
        API->>TableStorage: UpsertPlayerStatAsync(...)
        activate TableStorage

        TableStorage->>TableStorage: Calculate new stats<br/>(wins, losses, win %)
        TableStorage->>Azure: Upsert entity
        activate Azure
        Azure-->>TableStorage: Success
        deactivate Azure

        TableStorage-->>API: Success
        deactivate TableStorage

        Note over API,TelemetryClient: Track Custom Telemetry

        API->>TelemetryClient: TrackEvent("GameCompleted")
        Note right of TelemetryClient: Properties:<br/>PlayerName, Difficulty<br/>Result, GameTimeMs
        TelemetryClient->>AppInsights: Send event

        API->>TelemetryClient: TrackMetric("GameDuration")
        Note right of TelemetryClient: Value: GameTimeMs<br/>Dimensions: Difficulty, Result
        TelemetryClient->>AppInsights: Send metric

        API-->>HttpClient: 204 No Content
        deactivate API

        HttpClient-->>GamePage: Success
        deactivate HttpClient

        GamePage->>GamePage: Update local state
        GamePage->>User: Show "Stats saved!" message
    end

    deactivate GamePage

    Note over AppInsights: Telemetry available for<br/>KQL queries and dashboards
