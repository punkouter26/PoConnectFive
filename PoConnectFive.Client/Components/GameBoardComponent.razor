@namespace PoConnectFive.Client.Components
@using PoConnectFive.Shared.Models
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime

<div class="game-board" @ref="boardElementReference">
    <canvas id="gameCanvas" @ref="canvasReference" width="@(_boardWidth)" height="@(_boardHeight)"></canvas>
</div>

@code {
    [Parameter]
    public GameBoard? Board { get; set; }

    [Parameter]
    public GameState? CurrentState { get; set; }

    [Parameter]
    public EventCallback<int> OnColumnClicked { get; set; }

    [Parameter]
    public EventCallback OnAnimationComplete { get; set; }

    private ElementReference boardElementReference;
    private ElementReference canvasReference;
    private DotNetObjectReference<GameBoardComponent>? objRef;
    private int _boardWidth = 700; // Width and height match what's in the JS
    private int _boardHeight = 600;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("gameBoardInterop.initialize", 
                                        canvasReference, 
                                        objRef, 
                                        GameBoard.Rows, 
                                        GameBoard.Columns);
        }

        if (Board != null && CurrentState != null)
        {
            await JSRuntime.InvokeVoidAsync("gameBoardInterop.updateBoard", Board.GetBoard(), CurrentState.Status);
        }
    }

    [JSInvokable]
    public async Task OnColumnClickedFromJS(int column)
    {
        await OnColumnClicked.InvokeAsync(column);
    }

    [JSInvokable]
    public async Task OnAnimationCompleteFromJS()
    {
        await OnAnimationComplete.InvokeAsync();
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            if (objRef != null)
            {
                objRef.Dispose();
            }
            await JSRuntime.InvokeVoidAsync("gameBoardInterop.dispose");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error during disposal: {ex.Message}");
        }
    }
}
