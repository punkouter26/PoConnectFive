@inject IJSRuntime JS
@inject ILogger<InstallPrompt> Logger
@implements IDisposable

@if (_showPrompt)
{
    <div class="install-prompt @(_isIOS ? "install-prompt-ios" : "") fade-in">
        <div class="install-prompt-content">
            <button class="install-prompt-close" @onclick="DismissPrompt">âœ•</button>
            
            <div class="install-prompt-icon">ðŸ“±</div>
            
            <h3>Install PoConnectFive</h3>
            <p>Add to your home screen for a better experience!</p>
            
            @if (_isIOS)
            {
                <div class="ios-instructions">
                    <p><strong>To install on iOS:</strong></p>
                    <ol>
                        <li>Tap the Share button <span class="ios-icon">âŽ™</span></li>
                        <li>Select "Add to Home Screen"</li>
                        <li>Tap "Add" to confirm</li>
                    </ol>
                </div>
            }
            else
            {
                <button class="btn btn-primary install-button" @onclick="InstallApp">
                    Install App
                </button>
            }
            
            <button class="btn-link" @onclick="DismissPrompt">Maybe later</button>
        </div>
    </div>
}

@code {
    private bool _showPrompt = false;
    private bool _isIOS = false;
    private IJSObjectReference? _jsModule;
    private DotNetObjectReference<InstallPrompt>? _dotNetRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                _jsModule = await JS.InvokeAsync<IJSObjectReference>("import", "./js/pwa.js");
                _dotNetRef = DotNetObjectReference.Create(this);
                
                // Check if we should show the prompt
                var shouldShow = await _jsModule.InvokeAsync<bool>("shouldShowInstallPrompt");
                _isIOS = await _jsModule.InvokeAsync<bool>("isIOS");
                
                if (shouldShow)
                {
                    _showPrompt = true;
                    StateHasChanged();
                }
                
                // Register for install event
                await _jsModule.InvokeVoidAsync("registerInstallPrompt", _dotNetRef);
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error initializing PWA install prompt");
            }
        }
    }

    [JSInvokable]
    public void ShowPrompt()
    {
        _showPrompt = true;
        StateHasChanged();
    }

    private async Task InstallApp()
    {
        try
        {
            if (_jsModule != null)
            {
                await _jsModule.InvokeVoidAsync("installPWA");
                _showPrompt = false;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error installing PWA");
        }
    }

    private async Task DismissPrompt()
    {
        try
        {
            if (_jsModule != null)
            {
                await _jsModule.InvokeVoidAsync("dismissInstallPrompt");
            }
            _showPrompt = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error dismissing install prompt");
        }
    }

    public void Dispose()
    {
        _jsModule?.DisposeAsync();
        _dotNetRef?.Dispose();
    }
}

<style>
    .install-prompt {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        padding: 1.5rem;
        max-width: 400px;
        width: calc(100% - 2rem);
        z-index: 1000;
        animation: slide-up 0.3s ease-out;
    }

    .install-prompt-content {
        position: relative;
        text-align: center;
    }

    .install-prompt-close {
        position: absolute;
        top: -0.5rem;
        right: -0.5rem;
        background: transparent;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #666;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .install-prompt-close:hover {
        color: #000;
    }

    .install-prompt-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }

    .install-prompt h3 {
        margin: 0 0 0.5rem 0;
        font-size: 1.25rem;
        color: #333;
    }

    .install-prompt p {
        margin: 0 0 1rem 0;
        color: #666;
    }

    .install-button {
        width: 100%;
        margin-bottom: 0.5rem;
    }

    .ios-instructions {
        text-align: left;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
    }

    .ios-instructions p {
        margin: 0 0 0.5rem 0;
    }

    .ios-instructions ol {
        margin: 0;
        padding-left: 1.5rem;
    }

    .ios-instructions li {
        margin: 0.25rem 0;
        color: #666;
    }

    .ios-icon {
        font-size: 1.2rem;
        vertical-align: middle;
    }

    .btn-link {
        background: transparent;
        border: none;
        color: #007bff;
        cursor: pointer;
        text-decoration: underline;
        font-size: 0.875rem;
    }

    .btn-link:hover {
        color: #0056b3;
    }

    /* Mobile adjustments */
    @@media (max-width: 575.98px) {
        .install-prompt {
            bottom: 80px; /* Above bottom nav */
            width: calc(100% - 1rem);
        }

        .install-prompt-ios {
            bottom: 10px; /* iOS doesn't have bottom nav */
        }
    }

    @@keyframes slide-up {
        from {
            transform: translateX(-50%) translateY(100px);
            opacity: 0;
        }
        to {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
    }
</style>
