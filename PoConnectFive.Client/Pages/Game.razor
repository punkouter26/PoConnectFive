@page "/game"
@using PoConnectFive.Shared.Models
@using PoConnectFive.Shared.Interfaces
@using PoConnectFive.Shared.Services
@using PoConnectFive.Client.Components
@using PoConnectFive.Client.Services
@inject IGameService GameService
@inject IPlayerDataService PlayerDataService
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject WinProbabilityService WinProbabilityService
@inject GameStateService GameStateService
@inject GameStatisticsService StatisticsService
@inject SoundService SoundService

<PageTitle>Connect Five - Game</PageTitle>

<RadzenStack AlignItems="AlignItems.Center" Gap="2rem" Class="rz-p-4">
    
    @* Header Section *@
    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center" Style="width: 100%; max-width: 800px;">
        <RadzenButton Click="NavigateToMenu" Text="Back to Menu" Icon="arrow_back" ButtonStyle="ButtonStyle.Light" /> @* Changed ButtonStyle *@
        
        @if (_currentState != null)
        {
            <RadzenCard class="@GetStatusCardClass()" Style="flex-grow: 1; margin: 0 1rem;"> @* Used helper method for class *@
                 <RadzenStack AlignItems="AlignItems.Center" Gap="1rem">
                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Center" AlignItems="AlignItems.Center" Gap="1rem">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" Class="@(IsCurrentPlayer(_currentState.Player1) ? "player-active" : "")">
                            <RadzenText TextStyle="TextStyle.Subtitle1" Style="font-weight: bold;">@_currentState.Player1.Name</RadzenText>
                            <span class="player-piece-icon red"></span>
                        </RadzenStack>
                        <RadzenText Text="VS" Style="font-weight: bold; color: var(--rz-text-disabled-color);" />
                         <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" Class="@(IsCurrentPlayer(_currentState.Player2) ? "player-active" : "")">
                            <span class="player-piece-icon yellow"></span>
                            <RadzenText TextStyle="TextStyle.Subtitle1" Style="font-weight: bold;">@_currentState.Player2.Name</RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                    <RadzenStack AlignItems="AlignItems.Center" Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.H6" TagName="TagName.H2">@GetStatusMessage()</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2" TagName="TagName.P">@GetGameMessage()</RadzenText>
                    </RadzenStack>
                 </RadzenStack>
            </RadzenCard>
        }
        <div style="width: 130px;"></div> @* Spacer to balance the back button *@
    </RadzenStack>

    @* Game Board *@
    @if (_currentState != null)
    {
        <RadzenStack JustifyContent="JustifyContent.Center">
            <div class="game-board-container @(_isInvalidMove ? "board-shake" : "")">
                <GameBoardComponent @ref="gameBoardRef"
                                Board="@_currentState.Board"
                                CurrentState="@_currentState"
                                OnColumnClicked="OnColumnClicked"
                                OnAnimationComplete="OnAnimationComplete" />
            </div>
        </RadzenStack>
    }

    @* Game Controls *@
    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" JustifyContent="JustifyContent.Center">
        <RadzenButton Click="OnNewGameClick" Text="New Game" ButtonStyle="ButtonStyle.Primary" />
        <RadzenButton Click="OnResetClick" Text="Reset" ButtonStyle="ButtonStyle.Secondary" />
        <RadzenButton Click="ToggleMute" Icon="@(SoundService.IsMuted ? "volume_off" : "volume_up")" ButtonStyle="ButtonStyle.Light" />
    </RadzenStack>

</RadzenStack>

@code {
    private GameState? _currentState;
    private DateTime _gameStartTime;
    // Removed player IDs, using names and difficulty now for API calls
    private string? _player1Name; 
    private string? _player2Name; 
    private AIDifficulty? _aiDifficulty; // Store AI difficulty for stat updates
    private GameBoardComponent? gameBoardRef;
    private List<(int column, double probability)> winProbabilities = new();
    private bool _isWinning = false;
    private bool _isInvalidMove = false;

    protected override async Task OnInitializedAsync()
    {
        var uri = new Uri(NavigationManager.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        
        string? mode = query["mode"];
        if (mode == "single")
        {
            string? difficultyStr = query["difficulty"];
            if (Enum.TryParse<AIDifficulty>(difficultyStr, true, out var difficulty))
            {
                await StartNewGameWithAI(difficulty);
            }
        }
        else if (mode == "two-player")
        {
            await StartNewGameTwoPlayer();
        }
        else
        {
            await StartNewGameTwoPlayer(); // Default to two player mode
        }

        await UpdateWinProbabilities();
    }

    private async Task OnColumnClicked(int column)
    {
        if (_currentState?.Status != GameStatus.InProgress)
            return;

        try
        {
            if (await GameService.IsValidMove(_currentState, column))
            {
                var previousState = _currentState;
                _currentState = await GameService.MakeMove(_currentState, column);
                
                await SoundService.PlayPieceDrop();

                if (_currentState.Status != GameStatus.InProgress)
                {
                    _isWinning = true;
                    await SoundService.PlayWin();
                    await HandleGameEnd();
                }
            }
            else
            {
                _isInvalidMove = true;
                await SoundService.PlayError();
                StateHasChanged();
                await Task.Delay(300);
                _isInvalidMove = false;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error making move: {ex.Message}");
        }
    }

    private async Task HandleGameEnd()
    {
        var gameTime = DateTime.UtcNow - _gameStartTime;

        // Update player statistics via API only for games against AI
        if (_currentState?.Player2.Type == PlayerType.AI && _player1Name != null && _aiDifficulty.HasValue)
        {
            var result = _currentState.Status switch
            {
                GameStatus.Player1Won => GameResult.Win,
                GameStatus.Player2Won => GameResult.Loss, // Human (Player 1) lost
                GameStatus.Draw => GameResult.Draw,
                _ => (GameResult?)null // Should not happen if game ended
            };

            if (result.HasValue)
            {
                // Call the new UpdatePlayerStats overload
                await PlayerDataService.UpdatePlayerStats(_player1Name, _aiDifficulty.Value, result.Value, gameTime);
            }
        }
        // Note: Stats for Player 2 (AI or Human) in local games are not sent to the API currently.

        // Show game end dialog after a short delay to allow animation to complete
        await Task.Delay(500);
        var message = _currentState!.Status switch
        {
            GameStatus.Player1Won => $"ðŸŽ‰ {_currentState.Player1.Name} Wins! ðŸŽ‰",
            GameStatus.Player2Won => $"ðŸŽ‰ {_currentState.Player2.Name} Wins! ðŸŽ‰",
            GameStatus.Draw => "ðŸ¤ Game Draw! ðŸ¤",
             _ => string.Empty
         };
 
         var playAgain = await JSRuntime.InvokeAsync<bool>("confirm", $"{message}\n\nPlay again?");
         if (playAgain)
         {
            await OnResetClick();
        }
    }

    private async Task OnNewGameClick()
    {
        if (_currentState?.Status == GameStatus.InProgress)
        {
            if (!await JSRuntime.InvokeAsync<bool>("confirm", "Current game is in progress. Start new game anyway?"))
                return;
        }

        bool isAI = await JSRuntime.InvokeAsync<bool>("confirm", "Play against AI?");
        if (isAI)
        {
            var difficulties = Enum.GetNames(typeof(AIDifficulty));
            var difficultyChoice = await JSRuntime.InvokeAsync<string>("prompt", 
                $"Select AI Difficulty ({string.Join(", ", difficulties)}):", 
                difficulties[0]);

            if (!string.IsNullOrEmpty(difficultyChoice) && 
                Enum.TryParse<AIDifficulty>(difficultyChoice, true, out var difficulty))
            {
                await StartNewGameWithAI(difficulty);
            }
        }
        else
        {
            await StartNewGameTwoPlayer();
        }
    }

    private async Task StartNewGameWithAI(AIDifficulty difficulty)
    {
        _player1Name = await JSRuntime.InvokeAsync<string>("prompt", "Enter your name:", "Player 1");
        if (string.IsNullOrEmpty(_player1Name)) return;

        // Store player name and AI difficulty, remove direct interaction with PlayerDataService here
        _player2Name = $"AI ({difficulty})"; 
        _aiDifficulty = difficulty; 

        _gameStartTime = DateTime.UtcNow;
        _currentState = await GameService.StartNewGame(
            _player1Name,
            _player2Name, // Use stored AI name
            true,
            difficulty // Removed duplicate parameters
        );
        StateHasChanged();
    }

    private async Task StartNewGameTwoPlayer()
    {
        _player1Name = await JSRuntime.InvokeAsync<string>("prompt", "Enter name for Player 1:", "Player 1");
        if (string.IsNullOrEmpty(_player1Name)) return;

        _player2Name = await JSRuntime.InvokeAsync<string>("prompt", "Enter name for Player 2:", "Player 2");
        if (string.IsNullOrEmpty(_player2Name)) return;

        // Store names, clear AI difficulty, remove direct interaction with PlayerDataService here
        _aiDifficulty = null; 

        _gameStartTime = DateTime.UtcNow;
        _currentState = await GameService.StartNewGame(_player1Name, _player2Name);
        StateHasChanged();
    }

    private async Task OnResetClick()
    {
        if (_currentState?.Status == GameStatus.InProgress)
        {
            if (!await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to reset the current game?"))
                return;
        }

        _gameStartTime = DateTime.UtcNow;
        _currentState = await GameService.StartNewGame(
            _currentState!.Player1.Name,
            _currentState.Player2.Name,
            _currentState.Player2.Type == PlayerType.AI,
            _currentState.Player2.AIDifficulty
        );
        StateHasChanged();
    }

    private string GetStatusMessage()
    {
        return _currentState?.Status switch
        {
            GameStatus.InProgress => $"{_currentState.CurrentPlayer.Name}'s Turn",
            GameStatus.Player1Won => $"{_currentState.Player1.Name} Wins!",
            GameStatus.Player2Won => $"{_currentState.Player2.Name} Wins!",
            GameStatus.Draw => "Game Draw!",
            _ => string.Empty
        };
    }

    private string GetGameMessage()
    {
        return _currentState?.Status switch
        {
            GameStatus.InProgress => _currentState.CurrentPlayer.Type == PlayerType.AI ? 
                "AI is thinking..." : "Click a column to place your piece",
            _ => "Click New Game to play again"
        };
    }

    private bool IsCurrentPlayer(Player player)
    {
        return _currentState?.CurrentPlayer == player;
    }

    private async Task NavigateToMenu()
    {
        if (_currentState?.Status == GameStatus.InProgress)
        {
            bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Current game will be lost. Return to menu?");
            if (confirmed)
            {
                NavigationManager.NavigateTo("/");
            }
        }
        else
        {
            NavigationManager.NavigateTo("/");
         }
     }
 
     // Helper method for status card styling
     private string GetStatusCardClass()
     {
        return $"game-status-card {(_currentState?.Status.ToString().ToLower() ?? "")}";
    }

    private async Task MakeMove(int column)
    {
        try
        {
            _currentState = GameStateService.MakeMove(column);
            await UpdateWinProbabilities();
        }
        catch (InvalidOperationException ex)
        {
            // Handle invalid move
            Console.WriteLine($"Invalid move: {ex.Message}");
        }
    }

    private async Task UpdateWinProbabilities()
    {
        winProbabilities = await WinProbabilityService.CalculateWinProbabilities(GameStateService.GetCurrentState(), 1000);
        StateHasChanged();
    }

    private string GetCellClass(int playerId)
    {
        return playerId switch
        {
            1 => "red",
            2 => "yellow",
            _ => "empty"
        };
    }

    private void ToggleMute()
    {
        SoundService.ToggleMute();
    }

    private void NavigateToStatistics()
    {
        NavigationManager.NavigateTo("/statistics");
    }

    private void OnAnimationComplete()
    {
        _isWinning = false;
        StateHasChanged();
    }
}

<style>
    /* Style for player piece icons */
    .player-piece-icon {
        display: inline-block;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        vertical-align: middle;
    }

    .player-piece-icon.red {
        background: var(--color-player1, #FF0000);
    }

    .player-piece-icon.yellow {
        background: var(--color-player2, #FFFF00);
    }

    /* Highlight active player */
    .player-active {
         background-color: rgba(var(--rz-primary-rgb), 0.1);
         padding: 0.25rem 0.5rem;
         border-radius: var(--rz-border-radius);
    }

    /* Status card styling based on game outcome */
    .game-status-card.player1won {
        border-left: 4px solid var(--rz-success);
    }
    .game-status-card.player2won {
        border-left: 4px solid var(--rz-info);
    }
    .game-status-card.draw {
        border-left: 4px solid var(--rz-warning);
    }

    .game-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2rem;
        padding: 2rem;
    }

    .game-board {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        background-color: #1a237e;
        padding: 1rem;
        border-radius: 0.5rem;
    }

    .board-row {
        display: flex;
        gap: 0.5rem;
    }

    .board-cell {
        width: 50px;
        height: 50px;
        background-color: #0d47a1;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .cell-content {
        width: 40px;
        height: 40px;
        border-radius: 50%;
    }

    .empty {
        background-color: white;
    }

    .red {
        background-color: #f44336;
    }

    .yellow {
        background-color: #ffeb3b;
    }

    .game-info {
        text-align: center;
    }

    /* Board shake animation for invalid moves - animation defined in animations.css */
    .board-shake {
        animation: shake 0.3s ease-in-out;
    }
</style>
