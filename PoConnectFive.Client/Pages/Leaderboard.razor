@page "/leaderboard"
@using PoConnectFive.Shared.Models
@using PoConnectFive.Client.Services
@inject IPlayerDataService PlayerDataService
@inject NavigationManager NavigationManager
@implements IDisposable

<PageTitle>Connect Five - Leaderboard</PageTitle>

<div class="leaderboard-container">
    <div class="leaderboard-header">
        <button class="btn-back" @onclick="NavigateToMenu">
            <span>‚Üê</span> Back to Menu
        </button>
        <h1>Leaderboards</h1> @* Changed Title *@
    </div>

    <RadzenRow Gap="2rem">
        @* Easy Leaderboard *@
        <RadzenColumn Size="12" SizeLG="4">
            <RadzenText TextStyle="TextStyle.H5" TagName="TagName.H2" class="rz-text-align-center rz-mb-4">üòä Easy</RadzenText>
            <RadzenDataGrid AllowFiltering="false" AllowColumnResize="true" AllowAlternatingRows="false" AllowSorting="false" AllowPaging="false" 
                            Data="@_easyTopPlayers" TItem="PlayerStats" IsLoading=@_loadingEasy EmptyText="No Easy leaderboard data yet." Style="height: 350px;">
                <Columns>
                    <RadzenDataGridColumn TItem="PlayerStats" Title="#" Width="50px" TextAlign="TextAlign.Center">
                        <Template Context="data">@(_easyTopPlayers!.IndexOf(data) + 1)</Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="PlayerStats" Property="PlayerName" Title="Player" Width="150px" />
                    <RadzenDataGridColumn TItem="PlayerStats" Property="WinRate" Title="Win %" Width="80px" TextAlign="TextAlign.Center">
                        <Template Context="data">@($"{data.WinRate:F1}%")</Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="PlayerStats" Property="Wins" Title="Wins" Width="70px" TextAlign="TextAlign.Center" />
                    <RadzenDataGridColumn TItem="PlayerStats" Property="GamesPlayed" Title="Games" Width="70px" TextAlign="TextAlign.Center" />
                </Columns>
            </RadzenDataGrid>
        </RadzenColumn>

        @* Medium Leaderboard *@
         <RadzenColumn Size="12" SizeLG="4">
            <RadzenText TextStyle="TextStyle.H5" TagName="TagName.H2" class="rz-text-align-center rz-mb-4">ü§î Medium</RadzenText>
            <RadzenDataGrid AllowFiltering="false" AllowColumnResize="true" AllowAlternatingRows="false" AllowSorting="false" AllowPaging="false" 
                            Data="@_mediumTopPlayers" TItem="PlayerStats" IsLoading=@_loadingMedium EmptyText="No Medium leaderboard data yet." Style="height: 350px;">
                <Columns>
                    <RadzenDataGridColumn TItem="PlayerStats" Title="#" Width="50px" TextAlign="TextAlign.Center">
                        <Template Context="data">@(_mediumTopPlayers!.IndexOf(data) + 1)</Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="PlayerStats" Property="PlayerName" Title="Player" Width="150px" />
                    <RadzenDataGridColumn TItem="PlayerStats" Property="WinRate" Title="Win %" Width="80px" TextAlign="TextAlign.Center">
                        <Template Context="data">@($"{data.WinRate:F1}%")</Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="PlayerStats" Property="Wins" Title="Wins" Width="70px" TextAlign="TextAlign.Center" />
                    <RadzenDataGridColumn TItem="PlayerStats" Property="GamesPlayed" Title="Games" Width="70px" TextAlign="TextAlign.Center" />
                </Columns>
            </RadzenDataGrid>
        </RadzenColumn>

         @* Hard Leaderboard *@
         <RadzenColumn Size="12" SizeLG="4">
            <RadzenText TextStyle="TextStyle.H5" TagName="TagName.H2" class="rz-text-align-center rz-mb-4">ü§Ø Hard</RadzenText>
            <RadzenDataGrid AllowFiltering="false" AllowColumnResize="true" AllowAlternatingRows="false" AllowSorting="false" AllowPaging="false" 
                            Data="@_hardTopPlayers" TItem="PlayerStats" IsLoading=@_loadingHard EmptyText="No Hard leaderboard data yet." Style="height: 350px;">
                 <Columns>
                    <RadzenDataGridColumn TItem="PlayerStats" Title="#" Width="50px" TextAlign="TextAlign.Center">
                        <Template Context="data">@(_hardTopPlayers!.IndexOf(data) + 1)</Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="PlayerStats" Property="PlayerName" Title="Player" Width="150px" />
                    <RadzenDataGridColumn TItem="PlayerStats" Property="WinRate" Title="Win %" Width="80px" TextAlign="TextAlign.Center">
                        <Template Context="data">@($"{data.WinRate:F1}%")</Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="PlayerStats" Property="Wins" Title="Wins" Width="70px" TextAlign="TextAlign.Center" />
                    <RadzenDataGridColumn TItem="PlayerStats" Property="GamesPlayed" Title="Games" Width="70px" TextAlign="TextAlign.Center" />
                </Columns>
            </RadzenDataGrid>
        </RadzenColumn>
    </RadzenRow>
</div>

@code {
    // Lists and loading flags for each difficulty
    private List<PlayerStats>? _easyTopPlayers;
    private List<PlayerStats>? _mediumTopPlayers;
    private List<PlayerStats>? _hardTopPlayers;
    private bool _loadingEasy = true;
    private bool _loadingMedium = true;
    private bool _loadingHard = true;

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to data changes if needed for live updates (optional)
        // PlayerDataService.OnDataChanged += LoadAllLeaderboardsAsync; 
        await LoadAllLeaderboardsAsync();
    }

    private async Task LoadAllLeaderboardsAsync()
    {
        var easyTask = LoadLeaderboardAsync(AIDifficulty.Easy);
        var mediumTask = LoadLeaderboardAsync(AIDifficulty.Medium);
        var hardTask = LoadLeaderboardAsync(AIDifficulty.Hard);

        await Task.WhenAll(easyTask, mediumTask, hardTask);
        
        // Optional: Single StateHasChanged() after all loads complete
        StateHasChanged(); 
    }

    private async Task LoadLeaderboardAsync(AIDifficulty difficulty)
    {
        List<PlayerStats>? players = null;
        try
        {
            switch(difficulty)
            {
                case AIDifficulty.Easy: _loadingEasy = true; break;
                case AIDifficulty.Medium: _loadingMedium = true; break;
                case AIDifficulty.Hard: _loadingHard = true; break;
            }
            // StateHasChanged(); // Optional: Update UI to show loading spinner immediately

            players = await PlayerDataService.GetTopPlayers(difficulty, 5); // Fetch top 5
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading {difficulty} leaderboard: {ex.Message}");
            players = new List<PlayerStats>(); // Ensure list is not null on error
        }
        finally
        {
             switch(difficulty)
            {
                case AIDifficulty.Easy: 
                    _easyTopPlayers = players;
                    _loadingEasy = false; 
                    break;
                case AIDifficulty.Medium: 
                    _mediumTopPlayers = players;
                    _loadingMedium = false; 
                    break;
                case AIDifficulty.Hard: 
                    _hardTopPlayers = players;
                    _loadingHard = false; 
                    break;
            }
            // StateHasChanged(); // Update UI after this specific load completes
        }
    }

    private void NavigateToMenu()
    {
        NavigationManager.NavigateTo("/");
    }

    public void Dispose()
    {
        PlayerDataService.OnDataChanged -= StateHasChanged;
    }
}

<style>
    .leaderboard-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 2rem;
    }

    .leaderboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .leaderboard-header h1 {
        color: #2196F3;
        margin: 0;
    }

    .btn-back {
        padding: 0.5rem 1rem;
        background: transparent;
        border: none;
        color: #2196F3;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1rem;
    }

    .btn-back:hover {
        color: #1976D2;
    }

    /* Removed custom table styles as RadzenDataGrid handles styling */

    .loading-spinner {
        text-align: center;
        padding: 2rem;
    }

    .spinner {
        width: 40px;
        height: 40px;
        margin: 0 auto 1rem;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #2196F3;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .no-data {
        text-align: center;
        padding: 2rem;
        color: #666;
    }

    .no-data .btn-primary {
        margin-top: 1rem;
        padding: 0.75rem 1.5rem;
        background: #2196F3;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .no-data .btn-primary:hover {
        background: #1976D2;
    }
</style>
