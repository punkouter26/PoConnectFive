@page "/leaderboard"
@using PoConnectFive.Shared.Models
@using PoConnectFive.Client.Services
@inject IPlayerDataService PlayerDataService
@inject NavigationManager NavigationManager
@implements IDisposable

<PageTitle>Connect Five - Leaderboard</PageTitle>

<div class="leaderboard-container">
    <div class="leaderboard-header">
        <button class="btn-back" @onclick="NavigateToMenu">
            <span>‚Üê</span> Back to Menu
        </button>
        <h1>Leaderboard</h1>
    </div>

    @if (_loading)
    {
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Loading rankings...</p>
        </div>
    }
    else if (_players == null || !_players.Any())
    {
        <div class="no-data">
            <p>No player data available yet. Start playing to appear on the leaderboard!</p>
            <button class="btn-primary" @onclick="NavigateToMenu">Start Playing</button>
        </div>
    }
    else
    {
        <RadzenDataGrid AllowFiltering="true" AllowColumnResize="true" AllowAlternatingRows="false" FilterMode="FilterMode.Simple" AllowSorting="true" PageSize="10" AllowPaging="true" PagerHorizontalAlign="HorizontalAlign.Left" ShowPagingSummary="true"
                        Data="@_players" TItem="PlayerStats" ColumnWidth="200px" LogicalFilterOperator="LogicalFilterOperator.Or" IsLoading=@_loading EmptyText="No player data available yet.">
            <Columns>
                <RadzenDataGridColumn TItem="PlayerStats" Title="#" Sortable="false" Filterable="false" Width="60px" TextAlign="TextAlign.Center">
                    <Template Context="data">
                        @(_players!.IndexOf(data) + 1) 
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="PlayerStats" Property="PlayerName" Title="Player" Frozen="true" Width="200px">
                     <Template Context="data">
                        <RadzenStack Orientation="Orientation.Vertical" Gap="0">
                            <RadzenText TextStyle="TextStyle.Subtitle2">@data.PlayerName</RadzenText>
                            <RadzenText TextStyle="TextStyle.Caption">Last played: @data.LastPlayed.ToString("MMM dd, yyyy")</RadzenText>
                        </RadzenStack>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="PlayerStats" Property="WinRate" Title="Win Rate" Width="120px" TextAlign="TextAlign.Center">
                    <Template Context="data">
                        @($"{data.WinRate:F1}%")
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="PlayerStats" Property="Wins" Title="Wins" Width="100px" TextAlign="TextAlign.Center" />
                <RadzenDataGridColumn TItem="PlayerStats" Property="GamesPlayed" Title="Games" Width="100px" TextAlign="TextAlign.Center" />
                <RadzenDataGridColumn TItem="PlayerStats" Property="BestWinStreak" Title="Best Streak" Width="120px" TextAlign="TextAlign.Center" />
            </Columns>
             <EmptyTemplate>
                 <div class="no-data rz-p-4">
                    <p>No player data available yet. Start playing to appear on the leaderboard!</p>
                    <RadzenButton Click="NavigateToMenu" Text="Start Playing" ButtonStyle="ButtonStyle.Primary" />
                </div>
            </EmptyTemplate>
        </RadzenDataGrid>
    }
</div>

@code {
    private List<PlayerStats>? _players;
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        PlayerDataService.OnDataChanged += StateHasChanged;
        await LoadLeaderboard();
    }

    private async Task LoadLeaderboard()
    {
        try
        {
            _loading = true;
            _players = await PlayerDataService.GetTopPlayers();
            _players = _players.OrderByDescending(p => p.WinRate)
                             .ThenByDescending(p => p.Wins)
                             .ThenByDescending(p => p.GamesPlayed)
                             .ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading leaderboard: {ex.Message}");
            _players = new List<PlayerStats>();
        }
        finally
        {
            _loading = false;
        }
    }

    private void NavigateToMenu()
    {
        NavigationManager.NavigateTo("/");
    }

    public void Dispose()
    {
        PlayerDataService.OnDataChanged -= StateHasChanged;
    }
}

<style>
    .leaderboard-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 2rem;
    }

    .leaderboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .leaderboard-header h1 {
        color: #2196F3;
        margin: 0;
    }

    .btn-back {
        padding: 0.5rem 1rem;
        background: transparent;
        border: none;
        color: #2196F3;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1rem;
    }

    .btn-back:hover {
        color: #1976D2;
    }

    /* Removed custom table styles as RadzenDataGrid handles styling */

    .loading-spinner {
        text-align: center;
        padding: 2rem;
    }

    .spinner {
        width: 40px;
        height: 40px;
        margin: 0 auto 1rem;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #2196F3;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .no-data {
        text-align: center;
        padding: 2rem;
        color: #666;
    }

    .no-data .btn-primary {
        margin-top: 1rem;
        padding: 0.75rem 1.5rem;
        background: #2196F3;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .no-data .btn-primary:hover {
        background: #1976D2;
    }
</style>
